<template>
    <v-text-field
        id="searchBox"
        solo
        :placeholder="$i18n('Search_label')"
        hide-details
        class="search my-0"
        style=""
        name="cc5704978dc0411591addc66d25c325b"
        :value="currentSearchTerm"
        autofocus
        @input="onSearchInput"
        @keyup.arrow-down.stop.prevent="focusFirstResult"
        @keyup.enter.stop.prevent="focusFirstResult"
        @keyup.escape.stop.prevent="handleEscape"
    />
</template>

<script lang="ts">
import { names as actionNames } from "../../store/action-names";
import { configManager } from "../../common/ConfigManager";
import { Port } from "../../common/port";
import { SearcherAll } from "../../common/SearcherAll";
import store from "../../store";
import { KeeLog } from "../../common/Logger";
import { EntrySummary } from "../../common/model/EntrySummary";

export default {
    mixins: [Port.mixin],
    setup () {
        const { updateSaveState, updateCurrentSearchTerm } = store();
        return { updateSaveState, updateCurrentSearchTerm };
    },
    data() {
        return {};
    },
    computed: {
        ...mapGetters(["currentSearchTerm"])
    },
    created(this: any) {
        this.onDBChanged = () => {
            this.search = new SearcherAll(
                {
                    KeePassDatabases: this.$store.getters.KeePassDatabases,
                    ActiveKeePassDatabaseIndex: this.$store.getters.ActiveKeePassDatabaseIndex
                } as any,
                {
                    version: 1,
                    searchAllDatabases: configManager.current.searchAllOpenDBs,
                    maximumResults: 50
                }
            );
        };
        this.onDBChanged();
    },
    mounted(this: any) {
        //TODO: Find a way to trigger the onDBChanged function using pinia even though it no longer supplies a subscription to mutations feature.
        // Probably by using onAction instead of looking for mutations
        this.$store.subscribe((mutation: Mutation) => {
            if (mutation.type === mTypes.updateKeePassDatabases) {
                this.onDBChanged();
            }
        });
    },
    methods: {
        ...mapActions(actionNames),
        onSearchComplete(entrySummaries: EntrySummary[]) {
            KeeLog.debug("onSearchComplete");
            entrySummaries = entrySummaries
                .sort(function (a, b) {
                    if (a.relevanceScore > b.relevanceScore) return -1;
                    if (a.relevanceScore < b.relevanceScore) return 1;
                    return 0;
                })
                .map(l => Object.assign(l, { fullDetails: null }));
            this.updateSearchResults(entrySummaries);
        },
        onSearchInput(value) {
            // Think this is OK but if it is actually async then user may have subsequent
            // characters deleted when the change is actually applied
            this.updateCurrentSearchTerm(value);
            (this as any).search.execute(value, (this as any).onSearchComplete.bind(this), []);
        },
        focusFirstResult() {
            const firstCard = document.querySelector("#searchPanel > .v-card");
            if (firstCard) {
                (firstCard as HTMLLIElement).focus();
            }
        },
        handleEscape() {
            // This does not work in Firefox due to https://bugzilla.mozilla.org/show_bug.cgi?id=1373175
            const searchBox = document.getElementById("searchBox") as HTMLInputElement;
            if (searchBox.value) {
                searchBox.value = "";
                searchBox.dispatchEvent(new Event("input"));
            } else {
                window.close();
            }
        }
    }
};
</script>

<style>
.search.v-text-field.v-text-field--solo .v-input__control {
    min-height: 36px !important;
}
</style>
